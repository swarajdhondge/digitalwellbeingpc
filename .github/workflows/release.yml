name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  PROJECT: 'digital-wellbeing-app/digital-wellbeing-app.csproj'
  PACKAGE_NAME: 'DigitalWellbeingPC'

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk

      - name: Get version from tag
        id: version
        shell: powershell
        run: |
          $version = '${{ github.ref_name }}'.TrimStart('v')
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Publish application
        run: dotnet publish ${{ env.PROJECT }} -c Release -o ./publish

      - name: Create Velopack release
        run: vpk pack -u ${{ env.PACKAGE_NAME }} -v ${{ steps.version.outputs.VERSION }} -p ./publish -o ./releases --mainExe DigitalWellbeing.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          files: ./releases/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
